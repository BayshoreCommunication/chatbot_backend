name: CI/CD

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Show repo tree (debug)
        run: |
          pwd
          ls -la
          find . -maxdepth 3 -type f -iname "requirements*.txt" -print || true

      - name: Install deps (root requirements.txt)
        run: |
          set -e
          python -m pip install --upgrade pip wheel setuptools
          test -f requirements.txt || (echo "requirements.txt not found at repo root" && exit 1)
          pip install -r requirements.txt

      - name: Compile quick check
        run: |
          set -e
          FILES=$(git ls-files '*.py' || true)
          if [ -n "$FILES" ]; then python -m py_compile $FILES; else echo "No .py files"; fi

  deploy:
    needs: test
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trust SSH host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}

      - name: SSH preflight (whoami)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: whoami

      # Write the private key to a file and run rsync manually (most reliable)
      - name: Upload with rsync
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY:  ${{ secrets.SSH_KEY }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          set -e
          echo "$SSH_KEY" > id_ed25519
          chmod 600 id_ed25519
          rsync -avzr --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "venv/" \
            -e "ssh -i id_ed25519 -o StrictHostKeyChecking=no" \
            ./ "$SSH_USER@$SSH_HOST:$REMOTE_PATH"

      - name: Run remote deploy script
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: bash /var/www/chatbot_backend/deploy.sh
